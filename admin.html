<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Guru Software Solutions</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f5f5f5;
            color: #333;
        }

        .admin-container {
            display: flex;
            min-height: 100vh;
        }

        .sidebar {
            width: 250px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
        }

        .sidebar h1 {
            font-size: 1.3rem;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.3);
        }

        .sidebar-menu {
            list-style: none;
        }

        .sidebar-menu li {
            margin-bottom: 10px;
        }

        .sidebar-menu a {
            color: rgba(255, 255, 255, 0.9);
            text-decoration: none;
            padding: 10px 15px;
            display: block;
            border-radius: 5px;
            transition: all 0.3s ease;
        }

        .sidebar-menu a:hover,
        .sidebar-menu a.active {
            background-color: rgba(255, 255, 255, 0.2);
        }

        /* Modernized admin styles */
        .topbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 18px 24px;
            background: linear-gradient(90deg,#ffffff 0%, #f7f9fc 100%);
            border-bottom: 1px solid #e6eef8;
            box-shadow: 0 2px 6px rgba(20,40,80,0.03);
            margin-bottom: 20px;
            border-radius: 8px;
        }

        .topbar .title { font-size: 1.15rem; color: #223; font-weight: 600; }
        .topbar .meta { color: #557; font-size: 0.95rem; }

        .table-header { display:flex; gap:12px; align-items:center; justify-content:space-between; }
        .header-controls { display:flex; gap:10px; align-items:center; }
        .search-input { padding:8px 12px; border-radius:8px; border:1px solid #e3eef8; min-width:220px; }
        .small-btn { padding:6px 10px; font-size:0.85rem; border-radius:8px; border:1px solid rgba(0,0,0,0.06); background:#fff; }

        table { width:100%; border-collapse: collapse; border-radius:8px; overflow:hidden; }
        table thead th { background: linear-gradient(90deg,#f6f9ff,#ffffff); color:#234; font-weight:700; }
        table tbody tr:nth-child(even){ background:#fbfdff; }
        table tbody tr:hover { background:#eef6ff; transform: translateZ(0); }
        table td, table th { padding:12px 14px; }

        .empty-state { padding:40px; font-size:1rem; }

        .main-content {
            flex: 1;
            padding: 30px;
        }

        .dashboard-header {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .dashboard-header h2 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            text-align: center;
            border-top: 4px solid #667eea;
        }

        .stat-card h3 {
            color: #667eea;
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .stat-card p {
            color: #666;
        }

        .table-section {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            overflow: hidden;
        }

        .table-header {
            padding: 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .table-header h3 {
            color: #667eea;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        table thead {
            background-color: #f8f9fa;
            border-bottom: 2px solid #eee;
        }

        table th {
            padding: 15px;
            text-align: left;
            font-weight: 600;
            color: #667eea;
        }

        table td {
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
        }

        table tbody tr:hover {
            background-color: #f8f9fa;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .status-new {
            background-color: #fff3cd;
            color: #856404;
        }

        .status-reviewed {
            background-color: #d4edda;
            color: #155724;
        }

        .btn {
            padding: 8px 12px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }

        .btn-primary {
            background-color: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background-color: #764ba2;
        }

        .btn-danger {
            background-color: #f44336;
            color: white;
        }

        .btn-danger:hover {
            background-color: #da190b;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .error-message {
            background-color: #f8d7da;
            color: #721c24;
            padding: 12px 20px;
            border-radius: 5px;
            margin-bottom: 20px;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #999;
        }

        @media (max-width: 768px) {
            .admin-container {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            table {
                font-size: 0.9rem;
            }

            table th,
            table td {
                padding: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="admin-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <h1>Admin Panel</h1>
            <ul class="sidebar-menu">
                <li><a href="#statistics" class="menu-link active" onclick="loadStatistics()">Dashboard</a></li>
                <li><a href="#contacts" class="menu-link" onclick="loadContacts()">Contact Submissions</a></li>
                <li><a href="#applications" class="menu-link" onclick="loadApplications()">Job Applications</a></li>
            </ul>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Dashboard Section -->
            <div id="statistics" class="dashboard-section">
                    <div class="topbar">
                        <div>
                            <div class="title">üìä Dashboard Overview</div>
                            <div class="meta">View key statistics and metrics</div>
                        </div>
                        <div class="meta">Admin ‚Ä¢ Guru Software Solutions</div>
                    </div>
                <div class="stats-grid" id="statsGrid">
                    <div class="loading">Loading statistics...</div>
                </div>
            </div>

            <!-- Contact Submissions Section -->
            <div id="contacts" class="dashboard-section hidden">
                <div class="table-section">
                    <div class="table-header">
                        <h3>üìß Contact Submissions</h3>
                        <div class="header-controls">
                            <input id="contactSearch" class="search-input" placeholder="Search contacts by name, email or subject" oninput="filterContacts()" />
                            <button class="small-btn" onclick="loadContacts()">Refresh</button>
                            <button id="syncContactsBtn" class="small-btn" onclick="syncOfflineFromAdmin('contact')">Sync Offline (0)</button>
                        </div>
                    </div>
                    <div id="contactsTable"></div>
                </div>
            </div>

            <!-- Job Applications Section -->
            <div id="applications" class="dashboard-section hidden">
                <div class="table-section">
                    <div class="table-header">
                        <h3>üíº Job Applications</h3>
                        <div class="header-controls">
                            <input id="applicationSearch" class="search-input" placeholder="Search applications by name, email or role" oninput="filterApplications()" />
                            <button class="small-btn" onclick="loadApplications()">Refresh</button>
                            <button id="syncApplicationsBtn" class="small-btn" onclick="syncOfflineFromAdmin('application')">Sync Offline (0)</button>
                        </div>
                    </div>
                    <div id="applicationsTable"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        /**
         * Load statistics
         */
        const API_BASE = localStorage.getItem('api_base') || 'http://localhost:5000';
        
        function loadStatistics() {
            setActiveMenu('statistics');
            showSection('statistics');

            const fetchWithRetry = (url, retries = 3) => {
                return fetch(url, { timeout: 5000 })
                    .then(response => {
                        if (!response.ok) throw new Error(`HTTP ${response.status}`);
                        return response.json();
                    })
                    .catch(error => {
                        if (retries > 0) {
                            console.log(`Retry attempt ${4 - retries}/3`);
                            return new Promise(resolve => setTimeout(() => {
                                resolve(fetchWithRetry(url, retries - 1));
                            }, 1000));
                        }
                        throw error;
                    });
            };

            fetchWithRetry(`${API_BASE}/api/statistics`)
                .then(data => {
                    if (data && data.success && data.statistics) {
                        const stats = data.statistics;
                        const statsGrid = document.getElementById('statsGrid');
                        statsGrid.innerHTML = `
                            <div class="stat-card">
                                <h3>${stats.total_contacts || 0}</h3>
                                <p>Total Contact Submissions</p>
                            </div>
                            <div class="stat-card">
                                <h3>${stats.total_applications || 0}</h3>
                                <p>Total Job Applications</p>
                            </div>
                            <div class="stat-card">
                                <h3>${stats.new_contacts || 0}</h3>
                                <p>New Contacts</p>
                            </div>
                            <div class="stat-card">
                                <h3>${stats.new_applications || 0}</h3>
                                <p>New Applications</p>
                            </div>
                        `;
                    } else {
                        throw new Error('Invalid response format');
                    }
                })
                .catch(error => {
                    console.error('Statistics load error:', error);
                    const statsGrid = document.getElementById('statsGrid');
                    statsGrid.innerHTML = `
                        <div class="error-message" style="grid-column: 1/-1; text-align: center;">
                            <p>‚ö†Ô∏è Failed to load statistics</p>
                            <p style="font-size: 0.9rem; color: #999;">Ensure backend server is running at ${API_BASE}</p>
                            <button style="margin-top: 10px; padding: 8px 16px; background: #667eea; color: white; border: none; border-radius: 4px; cursor: pointer;" onclick="loadStatistics()">Retry</button>
                        </div>
                    `;
                });
        }

        /**
         * Load contact submissions
         */
        function loadContacts() {
            setActiveMenu('contacts');
            showSection('contacts');

            const contactsTable = document.getElementById('contactsTable');
            contactsTable.innerHTML = '<div class="loading">Loading contact submissions...</div>';

            fetch(`${API_BASE}/api/contact-submissions`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        if (data.submissions.length === 0) {
                            contactsTable.innerHTML = '<div class="empty-state">No contact submissions yet</div>';
                        } else {
                            let html = '<table><thead><tr><th>ID</th><th>Name</th><th>Email</th><th>Subject</th><th>Date</th><th>Status</th><th>Actions</th></tr></thead><tbody>';
                            data.submissions.forEach(submission => {
                                html += `
                                        <tr data-name="${(submission.name||'').toLowerCase()}" data-email="${(submission.email||'').toLowerCase()}" data-subject="${(submission.subject||'').toLowerCase()}">
                                            <td>${submission.id}</td>
                                            <td>${submission.name}</td>
                                            <td>${submission.email}</td>
                                            <td>${submission.subject}</td>
                                            <td>${new Date(submission.submitted_at).toLocaleDateString()}</td>
                                            <td><span class="status-badge status-${submission.status}">${submission.status}</span></td>
                                            <td>
                                                <button class="small-btn" onclick="viewSubmission(${submission.id})">View</button>
                                                <button class="small-btn" style="background:#f8d7da;color:#721c24;border:1px solid #f5c6cb;" onclick="deleteSubmission(${submission.id})">Delete</button>
                                            </td>
                                        </tr>
                                    `;
                            });
                            html += '</tbody></table>';
                            contactsTable.innerHTML = html;
                        }
                    } else {
                        contactsTable.innerHTML = '<div class="error-message">Failed to load contact submissions</div>';
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    contactsTable.innerHTML = '<div class="error-message">Error loading submissions</div>';
                });
        }

        /**
         * Load job applications
         */
        function loadApplications() {
            setActiveMenu('applications');
            showSection('applications');

            const applicationsTable = document.getElementById('applicationsTable');
            applicationsTable.innerHTML = '<div class="loading">Loading job applications...</div>';

            fetch(`${API_BASE}/api/job-applications`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        if (data.applications.length === 0) {
                            applicationsTable.innerHTML = '<div class="empty-state">No job applications yet</div>';
                        } else {
                            let html = '<table><thead><tr><th>ID</th><th>Name</th><th>Role</th><th>Email</th><th>Experience</th><th>Date</th><th>Status</th><th>Actions</th></tr></thead><tbody>';
                            data.applications.forEach(application => {
                                html += `
                                        <tr data-name="${(application.name||'').toLowerCase()}" data-email="${(application.email||'').toLowerCase()}" data-role="${(application.role||'').toLowerCase()}">
                                            <td>${application.id}</td>
                                            <td>${application.name}</td>
                                            <td>${application.role}</td>
                                            <td>${application.email}</td>
                                            <td>${application.experience}</td>
                                            <td>${new Date(application.applied_at).toLocaleDateString()}</td>
                                            <td><span class="status-badge status-${application.status}">${application.status}</span></td>
                                            <td>
                                                <button class="small-btn" onclick="viewApplication(${application.id})">View</button>
                                                <button class="small-btn" style="background:#f8d7da;color:#721c24;border:1px solid #f5c6cb;" onclick="deleteApplication(${application.id})">Delete</button>
                                            </td>
                                        </tr>
                                    `;
                            });
                            html += '</tbody></table>';
                            applicationsTable.innerHTML = html;
                        }
                    } else {
                        applicationsTable.innerHTML = '<div class="error-message">Failed to load job applications</div>';
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    applicationsTable.innerHTML = '<div class="error-message">Error loading applications</div>';
                });
        }

        /**
         * View submission details
         */
        function viewSubmission(id) {
            fetch(`${API_BASE}/api/contact-submission/${id}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const submission = data.submission;
                        alert(`From: ${submission.name}\nEmail: ${submission.email}\nPhone: ${submission.phone}\nSubject: ${submission.subject}\n\nMessage:\n${submission.message}`);
                    }
                })
                .catch(error => console.error('Error:', error));
        }

        /**
         * View application details
         */
        function viewApplication(id) {
            fetch(`${API_BASE}/api/job-application/${id}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const application = data.application;
                        alert(`Name: ${application.name}\nRole: ${application.role}\nEmail: ${application.email}\nPhone: ${application.phone}\nExperience: ${application.experience}\n\nMessage:\n${application.message}`);
                    }
                })
                .catch(error => console.error('Error:', error));
        }

        /**
         * Delete submission
         */
        function deleteSubmission(id) {
            if (confirm('Are you sure you want to delete this submission?')) {
                fetch(`${API_BASE}/api/contact-submission/${id}`, { method: 'DELETE' })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            loadContacts();
                        }
                    })
                    .catch(error => console.error('Error:', error));
            }
        }

        /**
         * Delete application
         */
        function deleteApplication(id) {
            if (confirm('Are you sure you want to delete this application?')) {
                fetch(`${API_BASE}/api/job-application/${id}`, { method: 'DELETE' })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            loadApplications();
                        }
                    })
                    .catch(error => console.error('Error:', error));
            }
        }

        /**
         * Set active menu item
         */
        function setActiveMenu(sectionId) {
            document.querySelectorAll('.menu-link').forEach(link => {
                link.classList.remove('active');
            });
            try {
                const sel = document.querySelector(`a[href="#${sectionId}"]`);
                if (sel) sel.classList.add('active');
            } catch (e) {
                console.warn('setActiveMenu: selector failed', e);
            }
        }

        /**
         * Show section
         */
        function showSection(sectionId) {
            document.querySelectorAll('.dashboard-section').forEach(section => {
                section.classList.add('hidden');
            });
            try {
                const el = document.getElementById(sectionId);
                if (el) el.classList.remove('hidden');
            } catch (e) {
                console.warn('showSection: element not found', e);
            }
        }

        // Add hidden class to style.css alternatives
        const style = document.createElement('style');
        style.textContent = '.hidden { display: none !important; }';
        document.head.appendChild(style);

        // Load dashboard on page load
        window.addEventListener('load', function() {
            try {
                loadStatistics();
            } catch (e) { console.error('loadStatistics error', e); }
            try {
                updateOfflineButtons();
            } catch (e) { console.error('updateOfflineButtons error', e); }
        });

        // Update offline buttons and optionally render queued items
        function getOfflineList(key) {
            try { return JSON.parse(localStorage.getItem(key) || '[]'); } catch (e) { return []; }
        }

        function updateOfflineButtons() {
            const contacts = getOfflineList('offline_contacts');
            const apps = getOfflineList('offline_applications');
            const sc = document.getElementById('syncContactsBtn');
            const sa = document.getElementById('syncApplicationsBtn');
            if (sc) sc.textContent = `Sync Offline (${contacts.length})`;
            if (sa) sa.textContent = `Sync Offline (${apps.length})`;
        }

        function syncOfflineFromAdmin(type) {
            const key = type === 'contact' ? 'offline_contacts' : 'offline_applications';
            const list = getOfflineList(key);
            if (!list.length) { alert('No offline items to sync'); return; }
            if (!confirm(`Send ${list.length} offline ${type === 'contact' ? 'contacts' : 'applications'} to server now?`)) return;

            list.slice().forEach(item => {
                if (type === 'contact') {
                    fetch(`${API_BASE}/api/contact`, { method: 'POST', headers: { 'Content-Type':'application/json' }, body: JSON.stringify(item) })
                        .then(r => r.json()).then(data => {
                            if (data && data.success) {
                                const current = getOfflineList('offline_contacts');
                                const filtered = current.filter(c => c._queued_at !== item._queued_at);
                                localStorage.setItem('offline_contacts', JSON.stringify(filtered));
                                updateOfflineButtons();
                                loadContacts();
                            }
                        }).catch(err => console.error('Admin sync contact failed', err));
                } else {
                    // application: if resume_data_url exists send FormData
                    if (item.resume_data_url) {
                        const fd = new FormData();
                        fd.append('name', item.name || ''); fd.append('email', item.email || ''); fd.append('phone', item.phone || ''); fd.append('role', item.role || ''); fd.append('experience', item.experience || ''); fd.append('message', item.message || '');
                        fd.append('resume', dataURLtoBlob(item.resume_data_url), item.resume_name || 'resume');
                        fetch(`${API_BASE}/api/apply-job`, { method: 'POST', body: fd })
                            .then(r => r.json()).then(data => {
                                if (data && data.success) {
                                    const current = getOfflineList('offline_applications');
                                    const filtered = current.filter(a => a._queued_at !== item._queued_at);
                                    localStorage.setItem('offline_applications', JSON.stringify(filtered));
                                    updateOfflineButtons();
                                    loadApplications();
                                }
                            }).catch(err => console.error('Admin sync app failed', err));
                    } else {
                        fetch(`${API_BASE}/api/apply-job`, { method: 'POST', headers: { 'Content-Type':'application/json' }, body: JSON.stringify(item) })
                            .then(r => r.json()).then(data => {
                                if (data && data.success) {
                                    const current = getOfflineList('offline_applications');
                                    const filtered = current.filter(a => a._queued_at !== item._queued_at);
                                    localStorage.setItem('offline_applications', JSON.stringify(filtered));
                                    updateOfflineButtons();
                                    loadApplications();
                                }
                            }).catch(err => console.error('Admin sync app failed', err));
                    }
                }
            });
        }

        // Client-side filtering for contacts
        function filterContacts() {
            const q = (document.getElementById('contactSearch').value || '').toLowerCase();
            const table = document.querySelector('#contactsTable table');
            if (!table) return;
            Array.from(table.tBodies[0].rows).forEach(row => {
                const name = row.getAttribute('data-name') || '';
                const email = row.getAttribute('data-email') || '';
                const subject = row.getAttribute('data-subject') || '';
                const visible = !q || name.includes(q) || email.includes(q) || subject.includes(q);
                row.style.display = visible ? '' : 'none';
            });
        }

        // Client-side filtering for applications
        function filterApplications() {
            const q = (document.getElementById('applicationSearch').value || '').toLowerCase();
            const table = document.querySelector('#applicationsTable table');
            if (!table) return;
            Array.from(table.tBodies[0].rows).forEach(row => {
                const name = row.getAttribute('data-name') || '';
                const email = row.getAttribute('data-email') || '';
                const role = row.getAttribute('data-role') || '';
                const visible = !q || name.includes(q) || email.includes(q) || role.includes(q);
                row.style.display = visible ? '' : 'none';
            });
        }

        // helper used by admin sync for converting dataURL to blob
        function dataURLtoBlob(dataurl) {
            const arr = dataurl.split(',');
            const mime = arr[0].match(/:(.*?);/)[1];
            const bstr = atob(arr[1]);
            let n = bstr.length;
            const u8arr = new Uint8Array(n);
            while (n--) { u8arr[n] = bstr.charCodeAt(n); }
            return new Blob([u8arr], { type: mime });
        }
    </script>
</body>
</html>
